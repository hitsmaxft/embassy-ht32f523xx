# Embassy HT32F523xx 开发待办事项

> **✅ SVD/PAC 验证完成**: 所有现有HAL代码已验证符合硬件规范，可安全继续开发

## 🚀 高优先级 - 核心功能完善

### 1. I2C驱动实现 (硬件验证 ✅)
- [ ] 创建 `src/i2c.rs` - 基于PAC I2C0/I2C1 (0x4004_8000/9000)
  - [ ] 主机模式支持 (支持中断19/20)
  - [ ] 从机模式支持
  - [ ] Embassy异步traits实现
  - [ ] 7位/10位地址支持
  - [ ] 错误处理和恢复
  - [ ] 时钟配置验证

### 2. SPI驱动实现 (硬件验证 ✅)
- [ ] 创建 `src/spi.rs` - 基于PAC SPI0/SPI1 (0x4000_4000/4004_4000)
  - [ ] 主/从模式支持 (支持中断21/22)
  - [ ] Embassy异步traits实现
  - [ ] 可配置时钟极性/相位
  - [ ] DMA集成准备
  - [ ] 多从机选择支持

### 3. ADC驱动实现 (硬件验证 ✅)
- [ ] 创建 `src/adc.rs` - 基于PAC ADC (0x4001_0000)
  - [ ] 单次转换模式 (支持中断8)
  - [ ] 连续转换模式
  - [ ] 多通道采样 (验证硬件支持8通道)
  - [ ] 内部温度传感器支持
  - [ ] 参考电压配置

### 4. Embassy 异步trait完善
- [ ] **uart.rs**: UART0/UART1支持 (PAC验证 ✅)
  - [ ] 添加UART0/UART1实例 (0x4000_1000/4004_1000, 中断25/26)
  - [ ] `embassy_hal::uart::Read` trait
  - [ ] `embassy_hal::uart::Write` trait
  - [ ] `embassy_hal::uart::ReadUntilIdle` trait
  - [ ] 统一USART和UART接口

### 5. DMA (PDMA) 支持实现 (硬件验证 ✅)
- [ ] 创建 `src/dma.rs` - 基于PAC PDMA (0x4009_0000)
  - [ ] 6通道DMA管理 (支持中断30/31)
  - [ ] 外设到内存传输
  - [ ] 内存到内存传输
  - [ ] 与UART/SPI/I2C/ADC集成
  - [ ] 环形缓冲区支持

## 🔧 中优先级 - 系统外设

### 6. 中断系统完善 (PAC验证 ✅)
- [ ] **interrupt.rs**: 完整实现所有32个中断
  - [ ] 实际ISR函数实现 (当前只有waker结构)
  - [ ] 中断优先级配置 (4位NVIC验证)
  - [ ] 嵌套中断支持
  - [ ] 缺失中断处理: ADC, I2C0/1, SPI0/1, UART0/1, DMA

### 7. 实时时钟 (RTC) 驱动 (硬件验证 ✅)
- [ ] 创建 `src/rtc.rs` - 基于PAC RTC (0x4006_a000)
  - [ ] 日期时间设置/读取 (支持中断1)
  - [ ] 闹钟功能
  - [ ] 低功耗模式支持
  - [ ] 外部32.768kHz晶振支持

### 8. 看门狗 (WDT) 驱动 (硬件验证 ✅)
- [ ] 创建 `src/wdt.rs` - 基于PAC WDT (0x4006_8000)
  - [ ] 独立看门狗配置
  - [ ] 超时中断支持
  - [ ] 系统复位功能
  - [ ] 低功耗模式行为

### 9. 比较器 (CMP) 驱动 (硬件验证 ✅)
- [ ] 创建 `src/cmp.rs` - 基于PAC CMP (0x4005_8000)
  - [ ] 双比较器支持 (CMP0/1, 支持中断7)
  - [ ] 可配置参考电压
  - [ ] 迟滞功能
  - [ ] 输出极性配置

## 🎯 低优先级 - 高级功能

### 10. I2S音频驱动 (硬件验证 ✅)
- [ ] 创建 `src/i2s.rs` - 基于PAC I2S (0x4002_6000)
  - [ ] 音频数据传输 (支持中断28)
  - [ ] 主/从模式
  - [ ] 多种采样率支持
  - [ ] DMA音频流支持

### 11. CRC计算单元 (硬件验证 ✅)
- [ ] 创建 `src/crc.rs` - 基于PAC CRC (0x4008_a000)
  - [ ] CRC16/CRC32支持
  - [ ] 可配置多项式
  - [ ] 硬件加速计算
  - [ ] 数据完整性验证

### 12. 高级定时器功能
- [ ] **timer.rs**: 扩展现有功能
  - [ ] MCTM (电机控制定时器) 支持 (0x4002_c000, 中断10)
  - [ ] 输入捕获模式
  - [ ] 输出比较模式
  - [ ] 编码器接口
  - [ ] 死区控制

## 🐛 Bug修复和改进 (基于验证结果)

### 13. 代码质量提升
- [x] **SVD/PAC合规性**: 验证完成 ✅
- [ ] **统一错误处理**: 替换所有 `panic!` 为结构化错误类型
- [ ] **文档完善**: 为所有公共API添加文档注释
- [ ] **单元测试**: 为核心功能添加测试用例
- [ ] **示例代码**: 为每个外设创建使用示例

### 14. 性能优化
- [ ] **内存使用优化**: 减少不必要的内存分配
- [ ] **编译时优化**: 使用更多const泛型
- [ ] **中断延迟**: 优化中断响应时间
- [ ] **DMA优化**: 减少CPU开销

### 7. 定时器功能扩展
- [ ] **timer.rs**: 高级功能
  - [ ] 输入捕获模式
  - [ ] 输出比较模式
  - [ ] 编码器接口
  - [ ] 多通道PWM同步

## 🎯 低优先级 - 高级功能

### 8. I2S驱动实现
- [ ] 创建 `src/i2s.rs`
  - [ ] 音频数据传输
  - [ ] 主/从模式
  - [ ] 不同采样率支持

### 9. 时钟系统优化
- [ ] **rcc.rs**: HSE时钟跟踪完善
  - [ ] 外部晶振配置
  - [ ] PLL配置优化
  - [ ] 时钟切换和监控

### 10. 电源管理
- [ ] 创建 `src/pwr.rs`
  - [ ] 低功耗模式
  - [ ] 睡眠/待机模式
  - [ ] 电源域管理

## 🐛 Bug修复和改进

### 11. 代码质量提升
- [ ] **统一错误处理**: 替换所有 `panic!` 为结构化错误类型
- [ ] **文档完善**: 为所有公共API添加文档注释
- [ ] **单元测试**: 为核心功能添加测试用例
- [ ] **示例代码**: 为每个外设创建使用示例

### 12. 性能优化
- [ ] **内存使用优化**: 减少不必要的内存分配
- [ ] **编译时优化**: 使用更多const泛型
- [ ] **中断延迟**: 优化中断响应时间

## 🔍 待调查问题

### 13. 硬件兼容性
- [ ] 验证所有寄存器定义与芯片手册一致
- [ ] 测试不同芯片型号的兼容性
- [ ] 确认引脚复用配置正确性

### 14. Embassy集成
- [ ] 验证与最新Embassy版本的兼容性
- [ ] 确保所有异步操作符合Embassy规范
- [ ] 性能基准测试

## 📋 完成状态跟踪

### ✅ 已完成
- [x] 基础GPIO实现
- [x] 时间单位定义
- [x] 基础RCC实现
- [x] 闪存NorFlash trait
- [x] 基础定时器和PWM
- [x] 项目结构重构

### 🔄 进行中
- [ ] Embassy异步trait实现
- [ ] 中断系统完善
- [ ] USB驱动优化

### 📅 计划中
- [ ] I2C驱动
- [ ] ADC驱动
- [ ] DMA支持

---

**更新日期**: 2025-10-27
**版本**: v0.2.0-dev